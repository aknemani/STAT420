---
title: 'STAT 420: Data Analysis Project'
author: "Apurva V. Hari, Alok K. Shukla"
date: "11/13/2016"
output:
  html_document:
    highlight: tango
    theme: flatly
    toc: yes
  pdf_document:
    fig_caption: yes
    highlight: tango
    toc: yes
  word_document:
    toc: yes
---


```{r setup, echo = FALSE, message = FALSE, warning = FALSE}
options(scipen = 1, digits = 4, width = 80)
library(knitr)
opts_chunk$set(tidy.opts=list(width.cutoff=60),tidy=TRUE)
```

## Team

- Size : 2
- Details :

Name           | NetID
-------------- | -------------
Apurva V. Hari | vhari2
Alok K. Shukla | alokks2





## Introduction

**Who's Your Daddy? Is He Rich Like Me?**
<br/>
\newline
 *A survey of economic mobility across generations in contemporary USA.*

### Dataset 

A snippet. (Only first few columns).
```{r kable,message=FALSE,echo=FALSE,warning=FALSE}

library(readr)
library(ggplot2)
library(leaps)
calc_loocv_rmse = function(model) {
sqrt(mean((resid(model) / (1 - hatvalues(model))) ^ 2))
}
mobility <- read.csv("mobility.csv")

knitr::kable(head(mobility)[,1:7])

```

#### Background

The data come from a large study, based on tax records, which allowed researchers to link the income of adults to the income of their parents several decades previously. For privacy reasons, we don???t have that individual-level data, but we do have aggregate statistics about economic mobility for several hundred communities, containing most of the American population, and covariate information about those communities. 

#### Description

The data file `mobility.csv` has information on 741 communities. The variable we want to predict is economic mobility; the rest are predictor variables or covariates.

1. Mobility: The probability that a child born in 1980???1982 into the lowest quin- tile (20%) of household income will be in the top quintile at age 30. Individuals are assigned to the community they grew up in, not the one they were in as adults.
2. Population in 2000.
3. Is the community primarily urban or rural?
4. Black: percentage of individuals who marked black (and nothing else) on cen- sus forms.
5. Racial segregation: a measure of residential segregation by race.
6. Income segregation: Similarly but for income.
7. Segregation of poverty: Specifically a measure of residential segregation for those in the bottom quarter of the national income distribution.
8. Segregation of affluence: Residential segregation for those in the top qarter.
9. Commute: Fraction of workers with a commute of less than 15 minutes.
10. Mean income: Average income per capita in 2000.
11. Gini: A measure of income inequality, which would be 0 if all incomes were perfectly equal, and tends towards 100 as all the income is concentrated among the richest individuals (see Wikipedia, s.v. ???Gini coefficient???).
12. Share 1%: Share of the total income of a community going to its richest 1%.
13. Gini bottom 99%: Gini coefficient among the lower 99% of that community.
14. Fraction middle class: Fraction of parents whose income is between the na- tional 25th and 75th percentiles.
15. Local tax rate: Fraction of all income going to local taxes.
16. Local government spending: per capita.
17. Progressivity: Measure of how much state income tax rates increase with in- come.
18. EITC: Measure of how much the state contributed to the Earned Income Tax Credit (a sort of negative income tax for very low-paid wage earners).
19. School expenditures: Average spending per pupil in public schools.
20. Student/teacher ratio: Number of students in public schools divided by num- ber of teachers.
21. Test scores: Residuals from a linear regression of mean math and English test scores on household income per capita.
22. Highschooldropoutrate:Also,residualsfromalinearregressionofthedropout rate on per-capita income.
23. Colleges per capita
24. College tuition: in-state, for full-time students
25. College graduation rate: Again, residuals from a linear regression of the actual graduation rate on household income per capita.
26. Labor force participation: Fraction of adults in the workforce.
27. Manufacturing: Fraction of workers in manufacturing.
28. Chinese imports: Growth rate in imports from China per worker between 1990 and 2000.
29. Teenage labor: fraction of those age 14???16 who were in the labor force.
30. Migration in: Migration into the community from elsewhere, as a fraction of 2000 population.
31. Migration out: Ditto for migration into other communities.
32. Foreign: fraction of residents born outside the US.
33. Social capital: Index combining voter turnout, participation in the census, and participation in community organizations.
34. Religious: Share of the population claiming to belong to an organized religious body.
35. Violent crime: Arrests per person per year for violent crimes.
36. Singlemotherhood:Numberofsinglefemalehouseholdswithchildrendivided by the total number of households with children.
37. Divorced: Fraction of adults who are divorced.
38. Married: Ditto.
39. Longitude: Geographic coordinate for the center of the community
40. Latitude: Ditto
41. ID: A numerical code, identifying the community.
42. Name: the name of principal city or town.
43. State: the state of the principal city or town of the community.



## Exploratory Data Analysis

### Map of mobility.

```{r,warning=FALSE,message=FALSE,tidy=TRUE}
library(ggplot2)
library(ggmap)
## Central co-ordinates of the region we are interested in.
usa_center = c(mean(mobility$Longitude),mean(mobility$Latitude))
## Get map
USAMap = ggmap(get_googlemap(center=usa_center, scale=1, zoom=2), extent="normal")
## Plot Mobility
USAMap + geom_point(aes(x=mobility$Longitude, y=mobility$Latitude), data=mobility, col="red", alpha=0.4,size=mobility$Mobility*8) + xlim(range(mobility$Longitude)) + ylim(range(mobility$Latitude))
```

### Scatterplots
1. Population
```{r,warning=FALSE,message=FALSE}
  
  popData = as.data.frame(cbind(mobility$Population,mobility$Mobility))
  popData = popData[complete.cases(popData),]
  colnames(popData) = c("Pop","Mobility")
  pred.Pop <- predict(lm(Mobility ~ Pop, data = popData))

  ## Added mapping
  p1 <- ggplot(popData, aes(x = Pop, y = Mobility))
  ## Overridden
  p1 + geom_point(col="blue") +
    geom_line(aes(y = pred.Pop,col="orange"))+geom_smooth()
```

2. Mean household income per capita

```{r,warning=FALSE,message=FALSE}
  
  incomeData = as.data.frame(cbind(mobility$Income,mobility$Mobility))
  incomeData = incomeData[complete.cases(incomeData),]
  colnames(incomeData) = c("Income","Mobility")
  pred.Inc <- predict(lm(Mobility ~ Income, data = incomeData))

  ## Added mapping
  p1 <- ggplot(incomeData, aes(x = Income, y = Mobility))
  ## Overridden
  p1 + geom_point(col="blue") +
    geom_line(aes(y = pred.Inc,col="orange"))+geom_smooth()
```
3. Racial segregation

```{r,warning=FALSE,message=FALSE}
  
  raceData = as.data.frame(cbind(mobility$Seg_racial,mobility$Mobility))
  raceData = raceData[complete.cases(raceData),]
  colnames(raceData) = c("Racial_Seg","Mobility")
  pred.Race <- predict(lm(Mobility ~ Racial_Seg, data = raceData))

  ## Added mapping
  p1 <- ggplot(raceData, aes(x = Racial_Seg, y = Mobility))
  ## Overridden
  p1 + geom_point(col="blue") +
    geom_line(aes(y = pred.Race,col="orange"))+geom_smooth()
```

4. Income share of the top 1%

```{r,warning=FALSE,message=FALSE}
  
  incomeData = as.data.frame(cbind(mobility$Share01,mobility$Mobility))
  incomeData = incomeData[complete.cases(incomeData),]
  colnames(incomeData) = c("Share01","Mobility")
  pred.Inc <- predict(lm(Mobility ~ Share01, data = incomeData))

  ## Added mapping
  p1 <- ggplot(incomeData, aes(x = Share01, y = Mobility))
  ## Overridden
  p1 + geom_point(col="blue") +
    geom_line(aes(y = pred.Inc,col="orange"))+geom_smooth()
```
5. Mean school expenditures per pupil

```{r,warning=FALSE,message=FALSE}
  
  schoolData = as.data.frame(cbind(mobility$School_spending,mobility$Mobility))
  schoolData = schoolData[complete.cases(schoolData),]
  colnames(schoolData) = c("SchoolSpend","Mobility")
  pred.Sch <- predict(lm(Mobility ~ SchoolSpend, data = schoolData))

  ## Added mapping
  p1 <- ggplot(schoolData, aes(x = SchoolSpend, y = Mobility))
  ## Overridden
  p1 + geom_point(col="blue") +
    geom_line(aes(y = pred.Sch,col="orange"))+geom_smooth()
```

6. Violent crime rate

```{r,warning=FALSE,message=FALSE}
  
  crimeData = as.data.frame(cbind(mobility$Violent_crime,mobility$Mobility))
  crimeData = crimeData[complete.cases(crimeData),]
  colnames(crimeData) = c("ViolentCrime","Mobility")
  pred.Sch <- predict(lm(Mobility ~ ViolentCrime, data = crimeData))

  ## Added mapping
  p1 <- ggplot(crimeData, aes(x = ViolentCrime, y = Mobility))
  ## Overridden
  p1 + geom_point(col="blue") +
    geom_line(aes(y = pred.Sch,col="orange"))+geom_smooth()
```
7. Fraction of workers with short commutes.

```{r,warning=FALSE,message=FALSE}
  
  commuteData = as.data.frame(cbind(mobility$Commute,mobility$Mobility))
  commuteData = commuteData[complete.cases(commuteData),]
  colnames(commuteData) = c("ShortCommute","Mobility")
  pred.Comm <- predict(lm(Mobility ~ ShortCommute, data = commuteData))

  ## Added mapping
  p1 <- ggplot(commuteData, aes(x = ShortCommute, y = Mobility))
  ## Overridden
  p1 + geom_point(col="blue") +
    geom_line(aes(y = pred.Comm,col="orange"))+geom_smooth()
```


### Linear Regression

1. All appropriate co-variates

```{r,warning=FALSE,message=FALSE}
library(leaps)
  
  mobilityData = mobility[complete.cases(mobility),]
  modelAll = lm(Mobility~.-Name-State-ID,data=mobilityData)
  nrow(mobilityData)/3
  model = summary(regsubsets(Mobility~.-Name-State-ID,data=mobilityData))
  (best_r2_ind = which.max(model$adjr2))
  model$which[best_r2_ind, ]
  # Lets fit this model
  coef(modelAll)[model$which[best_r2_ind, ]]
  better_model = lm(Mobility~ (Black+Seg_racial+Commute+Progressivity+Manufacturing+Religious+Single_mothers+Latitude)^2+I(Black^2)+I(Seg_racial^2)+I(Progressivity^2)+I(Manufacturing^2)+I(Religious^2)+I(Single_mothers^2)+I(Latitude^2),data=mobilityData)
  model_back_bic = step(better_model, direction = "backward", k = log(length(resid(better_model))),trace = 0)
  
  library(faraway)
  drops <- c("ID","Name","State","Urban")
  onlyNumericData = mobilityData[ , !(names(mobilityData) %in% drops)]
  round(cor(onlyNumericData), 2)
  
  
```

## Initial Modeling



## Diagnostics/Model Selection


## Final Model Inference


## Discussion

